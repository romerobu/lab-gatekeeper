= Lab 2 - Required labels
:author: Coral Romero
:email: cromerob@redhat.com
:imagesdir: ./images
:toc: left
:toc-title: Required labels


[Abstract]
In this second lab we are going to verify that every service, route and deployment match the same label as part of the deployment process.

As we are testing different kinds of resources like Deployment, Route and Service, we are going to deploy different constraints. 

:numbered:
== Deploy constraint

=== Deploy Constraint Template

First we need to deploy the constraint templates where we are going to check the existing labels of the object under test and use the substraction operator to check any missing label.

If you take a look to one of the templates you will see in this case we are doing a subtraction between array of labels.

----
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: requiredlabelssvc${USER}
spec:
  crd:
    spec:
      names:
        kind: RequiredLabelsSvc${USER}
      validation:
        # Schema for the `parameters` field
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package requiredlabelssvc${USER}
        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("You must provide labels: %v", [missing])
        }

----

You can deploy constraints both from the web console or cli:

*Web console*:

Go to `Home` -> `Explore` -> Type `ConstraintTemplate` -> Select `v1beta1` version.

Once you have selected `ConstraintTemplate` you will navigate to a page where you see the resource details.

Go to `Instances` tab and click on `Create ConstraintTemplate`, replace ${USER} with your username then paste the following yaml definitions separately:

----
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: requiredlabelssvc${USER}
spec:
  crd:
    spec:
      names:
        kind: RequiredLabelsSvc${USER}
      validation:
        # Schema for the `parameters` field
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package requiredlabelssvc${USER}
        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("You must provide labels: %v", [missing])
        }
----

----
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: requiredlabelsroute${USER}
spec:
  crd:
    spec:
      names:
        kind: RequiredLabelsRoute${USER}
      validation:
        # Schema for the `parameters` field
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package requiredlabelsroute${USER}
        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("You must provide labels: %v", [missing])
        }
----

----
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: requiredlabelsdeployment${USER}
spec:
  crd:
    spec:
      names:
        kind: RequiredLabelsDeployment${USER}
      validation:
        # Schema for the `parameters` field
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package requiredlabelsdeployment${USER}
        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("You must provide labels: %v", [missing])
        }
----


*CLI*:

You can deploy the templates with this command:

----
oc process -f lab-gatekeeper-files/lab2/constraintTemplateDeployment.yaml  -p USER=$USER  | oc apply -f -

  constrainttemplate.templates.gatekeeper.sh/requiredlabelsdeployment${USER] created

oc process -f lab-gatekeeper-files/lab2/constraintTemplateRoute.yaml -p USER=$USER  | oc apply -f -

  constrainttemplate.templates.gatekeeper.sh/requiredlabelsroute${USER} created

oc process -f lab-gatekeeper-files/lab2/constraintTemplateSvc.yaml -p USER=$USER  | oc apply -f -

  constrainttemplate.templates.gatekeeper.sh/requiredlabelssvc${USER} created
----

=== Deploy Constraint 

Additionally we need to deploy the constraints where we are going to limite the impact to `petclinic-bluegreen-$USER` namespace and specify the required label.

For this example parameters are:

- Namaspace where the rule is implemented: `petclinic-bluegreen-$USER`.
- Resource under test: `Deployment`, `Service` and `Route`.
- Required label: `app`.
- Enforcement action: `deny`.

*WebConsole*:

After creating the instance you should see the recently created resource in a list. Then as per your yaml definition you should be able to list three  CRDs called `RequiredLabelsDeployment${USER}`, `RequiredLabelsSvc${USER}` and `RequiredLabelsRoute${USER}` in the main menu.

Repeat the same procedure for these new CRDs and paste your yaml definition after changing the ${USER} value for your username:

WARNING: It may take a while till those are listed.

----
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: RequiredLabelsSvc${USER}
metadata:
  name: required-label-service-${USER}
spec:
  enforcementAction: deny       
  match:
    namespaces:
      - "petclinic-bluegreen-${USER}"      
    kinds:
      - apiGroups: ["*"]
        kinds: ["Service"]
  parameters:
    labels: ["app"]
----

----
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: RequiredLabelsRoute${USER}
metadata:
  name: required-label-route-${USER}
spec:
  enforcementAction: deny
  match:
    namespaces:
      - "petclinic-bluegreen-${USER}"
    kinds:
      - apiGroups: ["*"]
        kinds: ["Route"]
  parameters:
    labels: ["app"]
----

----
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: RequiredLabelsDeployment${USER}
metadata:
  name: required-label-deployment-${USER}
spec:
  enforcementAction: deny
  match:
    namespaces:
      - "petclinic-bluegreen-${USER}"
    kinds:
      - apiGroups: ["*"]
        kinds: ["Deployment"]
  parameters:
    labels: ["app"]
----

*CLI*:

----
oc process -f lab-gatekeeper-files/lab2/constraint-deployment.yaml -p USER=$USER  | oc apply -f -

 requiredlabelsdeploymentcromerob.constraints.gatekeeper.sh/required-label-deployment-${USER} created

oc process -f lab-gatekeeper-files/lab2/constraint-route.yaml -p USER=$USER  | oc apply -f -

 requiredlabelsroutecromerob.constraints.gatekeeper.sh/required-label-route-${USER} created

oc process -f lab-gatekeeper-files/lab2/constraint-svc.yaml -p USER=$USER  | oc apply -f -

 requiredlabelssvccromerob.constraints.gatekeeper.sh/required-label-service-${USER} created
----

== Test constraint

=== Test positive case

For testing the positive case we are going to deploy these resources to the allowed namespace `petclinic-bluegreen-$USER`.
You should expect these resources to be deployed properly because they accomplish the constraints.

*WebConsole*:

To deploy your resources go to `Workloads` and `Networking`, then on `Deployment`, `Services` and `Routes` selector your namespaces `petclinic-bluegreen-$USER` and click on `Create`.

Finally paste the corresponding section of the yaml description.

----
cat lab-gatekeeper-files/lab2/deploy-app-blue.yaml
----

*CLI*:

----
oc apply -f lab-gatekeeper-files/lab2/deploy-app-blue.yaml -n petclinic-bluegreen-$USER

  deployment.apps/quarkus-petclinic-blue created
  route.route.openshift.io/quarkus-petclinic-bluegreen created
  service/quarkus-petclinic-blue created
----

=== Test negative case

For testing the negative case we are going to deploy a set of non-compliance resources to the namespaces.

As these resources don't include the required label you should be prompted with error message `You must provide labels: {"app"}" as they don't have the required labels`.

*Web Console*:

To deploy your resources go to `Workloads` and `Networking`, then on `Deployment`, `Services` and `Routes` selector your namespaces `petclinic-bluegreen-$USER` and click on `Create`.

Finally paste the corresponding section of the yaml description.

----
cat lab-gatekeeper-files/lab2/deploy-app-green.yaml
----

You will be prompted with this error message:

image:rlerror.png[rlerror]

*CLI*:

----
oc apply -f lab-gatekeeper-files/lab2/deploy-app-green.yaml -n petclinic-bluegreen-$USER

  Error from server ([denied by required-label-deployment-cromerob] You must provide labels: {"app"}): error when creating "lab-gatekeeper-files/lab2/deploy-app-green.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [denied by required-label-deployment-cromerob] You must provide labels: {"app"}
  
  Error from server ([denied by required-label-route-cromerob] You must provide labels: {"app"}): error when applying patch:
{"metadata":{"annotations":{"kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"route.openshift.io/v1\",\"kind\":\"Route\",\"metadata\":{\"annotations\":{},\"labels\":{\"gatekeeper\":\"quarkus-petclinic-green\"},\"name\":\"quarkus-petclinic-bluegreen\",\"namespace\":\"petclinic-bluegreen-cromerob\"},\"spec\":{\"port\":{\"targetPort\":\"8080-tcp\"},\"to\":{\"kind\":\"Service\",\"name\":\"quarkus-petclinic-green\",\"weight\":100},\"wildcardPolicy\":\"None\"}}\n"},"labels":{"app":null,"gatekeeper":"quarkus-petclinic-green"}},"spec":{"to":{"name":"quarkus-petclinic-green"}}}
to:
Resource: "route.openshift.io/v1, Resource=routes", GroupVersionKind: "route.openshift.io/v1, Kind=Route"
Name: "quarkus-petclinic-bluegreen", Namespace: "petclinic-bluegreen-cromerob"
for: "lab-gatekeeper-files/lab2/deploy-app-green.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [denied by required-label-route-cromerob] You must provide labels: {"app"}
  
  Error from server ([denied by required-label-service-cromerob] You must provide labels: {"app"}): error when creating "lab-gatekeeper-files/lab2/deploy-app-green.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [denied by required-label-service-cromerob] You must provide labels: {"app"}


----

== Dryrun

The recently deployed constraints were created as in the first lab with enforcement mode to `deny` however gatekeeper offers other mode called `dryrun` which enables constraints to be deployed without enforcing them. This means that non compliance resources will be created but violations will be audited.

If we patch the existing constraints to change the enforcement mode to `dryrun` and the try to redeploy the resources we should be able to create all of them but violations will be registered on the status section.

*Web Console*:

To deploy your resources go to `Explore`, search `RequiredLabelsDeployment${USER}` , `RequiredLabelsRoute${USER}` and `RequiredLabelsSvc${USER}`  and then go to `Instances` tab and select yours. Then on `Yaml` tab edit the enforcement mode to `dryrun`. Finally click on `Save`.

image:dryrun.png[dryrun]

Now let's try to redeploy the missing labels resources. Go to `Workloads` and `Networking`, then on `Deployment`, `Services` and `Routes` selector your namespaces `petclinic-bluegreen-$USER` and click on `Create`.

Finally paste the corresponding section of the yaml description.

----
cat lab-gatekeeper-files/lab2/deploy-app-green.yaml
----


*CLI*:

Patch the enforcement mode using the oc client:

----
oc patch requiredlabelsdeployment${USER}.constraints.gatekeeper.sh/required-label-deployment-${USER} -p '{"spec":{"enforcementAction":"dryrun"}}' --type merge

 requiredlabelsdeployment${USER}.constraints.gatekeeper.sh/required-label-deployment-${USER} patched

oc patch requiredlabelssvc${USER}.constraints.gatekeeper.sh/required-label-service-${USER}  -p '{"spec":{"enforcementAction":"dryrun"}}' --type merge

 requiredlabelssvc${USER}.constraints.gatekeeper.sh/required-label-service-${USER} patched 

oc patch requiredlabelsroute${USER}.constraints.gatekeeper.sh/required-label-route-${USER} -p '{"spec":{"enforcementAction":"dryrun"}}' --type merge

 requiredlabelsroute${USER}.constraints.gatekeeper.sh/required-label-route-${USER} patched
----

Then let's try to redeploy the missing labels resources:

----
oc apply -f lab-gatekeeper-files/lab2/deploy-app-green.yaml -n petclinic-bluegreen-$USER

 deployment.apps/quarkus-petclinic-green created
 route.route.openshift.io/quarkus-petclinic-bluegreen configured
 service/quarkus-petclinic-green created
----


Finally check the status of the violated constraints:

WARNING: You may need to wait the audit interval time till status is updated.

----
oc get requiredlabelsdeployment${USER}.constraints.gatekeeper.sh/required-label-deployment-${USER} -o yaml
oc get requiredlabelssvc${USER}.constraints.gatekeeper.sh/required-label-service-${USER} -o yaml
oc get requiredlabelsroute${USER}.constraints.gatekeeper.sh/required-label-route-${USER} -o yaml
----


*Web Console*:

Navigate to your constraint resource, select your instance and take a look at the status section at `Yaml` tab:

image:status.png[status]


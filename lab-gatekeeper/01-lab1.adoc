= Lab 1 - Max replicas
:author: Coral Romero
:email: cromerob@redhat.com
:imagesdir: ./images
:toc: left
:toc-title: Max replicas


[Abstract]
This lab aims to introduce how Gatekeeper works and its basic configuration. 
If your environment was set up properly you should be able to log in with your gatekeeper-ops-role user.
Once you are logged in you should be able to have enough privileges to create gatekeeper resources like constraints and view resources like gatekeeper and config but not cluster-admin.


== Deploy constraint

=== Deploy ConstraintTemplate

First of all you need to deploy the constraint template to define the rule pattern for limiting the amount of replicas.
You can deploy it with this command:

----
oc apply -f lab-gatekeeper-files/lab1/constraintTemplate.yaml
----

As you can see, this constraint template is written using the rego syntax mentioned before. It compares that the constraint integer input is not greater than the replicas value of the object under test.

=== Deploy Constraint

After deploying the constraint template you can deploy the constraint resource which defines:

- Namespace where the rule is implemented: petclinic-bluegreen-$USER.
- Resource under test: Deployment.
- Replicas parameter: 3.
- Enforcement action: deny. Deny means you won't be allowed to create the resource.

----
oc apply -f lab-gatekeeper-files/lab1/constraint.yaml
----

== Test constraint

=== Test positive case

For testing a positive case where deployment accomplish the constraint run this command to deploy a deployment whose replicas value is 2:

----
oc apply -f  lab-gatekeeper-files/lab1/deploy-app-blue.yaml -n petclinic-bluegreen-$USER
----

As you can see, you are allowed to create the resources and there is no violation on the constraint status:

----
oc get constraint maxreplicas -o yaml
----

On the status section you can see two sections:

 - auditTimestamp: this timestamp indicates when the last check happened. This frequency can be overrided on gatekeeper resource.
 - byPod: this section shows three pods created on "openshift-gatekeeper-system" namespace. This pods resume all the logs from audit feature, compiling all the information regarding constraints and violations like count of constraints, resources under test and violations.

Finally verify to can navigate to the app you just deployed:

----
 oc get route -o jsonpath='{range .items[*].spec}{"Host: "}{.host}{"\n"}{end}'
----

=== Test negative case

For testing a negative case where deployment doesn't accomplish the constraint run this command to patch current replicas value to 5:

----
oc patch deployment/quarkus-petclinic-blue -p '{"spec":{"replicas":5}}' --type merge
----

As you can see you cannot create this deployment resource and you are prompted with error message "Deployment 5 pods is higher than the maximum allowed of 3". This error message is customized on constraint resource.
Furthermore as you weren't allowed to create the resource, there won't be any non-compliance resource so constraint won't be hooked and there should not be any violation on status section.

WARNING: Audit interval is 60 seconds by default, so you may need to wait this time to see any update.


To end this lab, delete every resource:

----
oc delete all --selector app=quarkus-petclinic-blue
----

= Lab 1 - Max replicas
:author: Coral Romero
:email: cromerob@redhat.com
:imagesdir: ./images
:toc: left
:toc-title: Max replicas


[Abstract]
This lab aims to introduce how Gatekeeper works and its basic configuration.
 
If your environment was set up properly you should be able to log in with your `gatekeeper-ops-role user`.

Once you are logged in you should be able to have enough privileges to create gatekeeper resources like constraints and view resources like gatekeeper and config but not `cluster-admin`.

To start verify you are on your project:

----
oc project petclinic-bluegreen-$USER
----

== Deploy constraint

=== Deploy ConstraintTemplate

First of all you need to deploy the constraint template to define the rule pattern for limiting the amount of replicas.

If you take a look to the template you will see first the type of value you will compare your replicas with and the pattern of the rule.
Finally the error message it will be prompted when the webhook triggers this constraint.

----
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: maxreplicas${USER}
spec:
  crd:
    spec:
      names:
        kind: MaxReplicas${USER}
      validation:
        openAPIV3Schema:
          properties:
            replicas:
              type: integer 
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package maxreplicas${USER}

        violation[{"msg": msg}] {
          replicas := input.review.object.spec.replicas
          max_replicas := input.parameters.replicas
          to_number(replicas) > to_number(max_replicas)
          msg := sprintf("Deployment %v pods is higher than the maximum allowed of %v", [replicas, max_replicas])
        }
----

You can deploy constraints both from the web console or cli:

*Web console*:

Go to `Home` -> `Explore` -> Type `ConstraintTemplate` -> Select `v1beta1` version.

Once you have selected `ConstraintTemplate` you will navigate to a page where you see the resource details.

Go to `Instances` tab and click on `Create ConstraintTemplate`, then replace ${USER} with your username and paste the yaml definition:

----
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: maxreplicas${USER}
spec:
  crd:
    spec:
      names:
        kind: MaxReplicas${USER}
      validation:
        openAPIV3Schema:
          properties:
            replicas:
              type: integer 
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package maxreplicas${USER}

        violation[{"msg": msg}] {
          replicas := input.review.object.spec.replicas
          max_replicas := input.parameters.replicas
          to_number(replicas) > to_number(max_replicas)
          msg := sprintf("Deployment %v pods is higher than the maximum allowed of %v", [replicas, max_replicas])
        }
----

*CLI*:

You can deploy it with this command:

Bear in mind you don't usually need to create a template for deploying a constraint however as per required for making this lab multi user friendly we can deploy it with `oc process` command:

----
oc process -f lab-gatekeeper-files/lab1/constraintTemplate.yaml  -p USER=$USER  | oc apply -f -

 constrainttemplate.templates.gatekeeper.sh/maxreplicas${USER} created
----

As you can see, this constraint template is written using the rego syntax mentioned before. It compares that the constraint integer input is not greater than the replicas value of the object under test.

=== Deploy Constraint

After deploying the constraint template you can deploy the constraint resource which defines:

- Namespace where the rule is implemented: `petclinic-bluegreen-$USER`.
- Resource under test: `Deployment`.
- Replicas parameter: 3.
- Enforcement action: `deny`. Deny means you won't be allowed to create the resource.

If you take a look to the constraint you will see how those values are specified on the resource as well as the template format.

*WebConsole*:

After creating the instance you should see the recently created resource in a list. Then as per your yaml definition you should be able to list a nex CRD called `MaxReplicas` in the main menu. 
Repeat the same procedure for this new CRD and paste your yaml definition after changing the ${USER} value for your username:

----
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: MaxReplicas${USER}
metadata:
  name: maxreplicas${USER}
spec:
  enforcementAction: deny      
  match:
    namespaces:
      - "petclinic-bluegreen-${USER}"      
    kinds:
      - apiGroups: ["*"]
        kinds: ["Deployment"]
  parameters:
    replicas: 3
----


*CLI*:
----
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: template-maxreplicas-${USER}
objects:
- apiVersion: constraints.gatekeeper.sh/v1beta1
  kind: MaxReplicas${USER}
  metadata:
    name: maxreplicas${USER}
  spec:
    enforcementAction: deny      
    match:
      namespaces:
        - "petclinic-bluegreen-${USER}"      
      kinds:
        - apiGroups: ["*"]
          kinds: ["Deployment"]
    parameters:
      replicas: 3
parameters:
- name: USER
  description: "Username"
  required: true
  value: ${USER}
----

You can deploy it with this command:

----
oc process -f lab-gatekeeper-files/lab1/constraint.yaml -p USER=$USER  | oc apply -f -

 maxreplicas${USER}.constraints.gatekeeper.sh/maxreplicas${USER} created
----

== Test constraint

=== Test positive case

*CLI*:

For testing a positive case where a deployment accomplish the constraint run this command to deploy an app whose deployment replicas value is 2:

----
oc apply -f  lab-gatekeeper-files/lab1/deploy-app-blue.yaml -n petclinic-bluegreen-$USER

  deployment.apps/quarkus-petclinic-blue created
  route.route.openshift.io/quarkus-petclinic-bluegreen created
  service/quarkus-petclinic-blue created
----

As you can see, you are allowed to create the resources and there is no violation on the constraint status:

----
oc get constraints maxreplicas${USER} -o yaml

  apiVersion: constraints.gatekeeper.sh/v1beta1
  kind: MaxReplicascromerob
  metadata:
    annotations:
    ....
----

On the `status` part you can see two sections:

 - `auditTimestamp`: this timestamp indicates when the last check happened. This frequency can be overrided on gatekeeper resource.
 - `byPod`: this section shows three pods created on `openshift-gatekeeper-system` namespace. These pods resume all the logs from audit feature, compiling all the information regarding constraints and violations like count of constraints, resources under test and violations.

Finally verify to can navigate to the app you just deployed:

----
oc get route -o jsonpath='{range .items[*].spec}{"Host: "}{.host}{"\n"}{end}' -n petclinic-bluegreen-$USER

  Host: quarkus-petclinic-bluegreen-petclinic-bluegreen-${USER}.apps.${APPS_CLUSTER}.opentlc.com
----

*Web Console*:

To deploy your resources go to `Workloads` and `Networking`, then on `Deployment`, `Services` and `Routes` select your namespace `petclinic-bluegreen-$USER` and click on `Create`.

image:svc.png[service]


Finally paste the corresponding section of the yaml description.

----
cat lab-gatekeeper-files/lab1/deploy-app-blue.yaml
----

After doing this you should be able to access the route. Go to `Networking`, then `Route` and click on `quarkus-petclinic-bluegreen`:

image:route.png[route]

=== Test negative case

*CLI*:

For testing a negative case where deployment doesn't accomplish the constraint run this command to patch current replicas value to 5:

----
oc patch deployment/quarkus-petclinic-blue -p '{"spec":{"replicas":5}}' --type merge

  Error from server ([denied by maxreplicascromerob] Deployment 5 pods is higher than the maximum allowed of 3): admission webhook "validation.gatekeeper.sh" denied the request: [denied by maxreplicascromerob] Deployment 5 pods is higher than the maximum allowed of 3
----

As you can see you cannot create this deployment resource and you are prompted with error message `Deployment 5 pods is higher than the maximum allowed of 3`. This error message is customized on constraint resource.

Furthermore as you weren't allowed to create the resource, there won't be any non-compliance resource so constraint won't be hooked and there should not be any violation on status section.

WARNING: Audit interval is 60 seconds by default, so you may need to wait this time to see any update.

*Web Console*:

To deploy your resources go to `Workloads` , then on `Deployment` and select your deployment `quarkus-petclinic-blue`. Then on `Yaml` tab edit the replicas amout to 5. Finally click on `Save`.

image:maxreplicaspatch.png[maxreplicas]

As you can see you cannot create this deployment resource and you are prompted with error message `Deployment 5 pods is higher than the maximum allowed of 3`.


To end this lab, delete every resource:

----
oc delete all --selector app=quarkus-petclinic-blue  -n petclinic-bluegreen-$USER
  
  pod "quarkus-petclinic-blue-75f67dfddf-8s5wg" deleted
  pod "quarkus-petclinic-blue-75f67dfddf-mm24h" deleted
  service "quarkus-petclinic-blue" deleted
  deployment.apps "quarkus-petclinic-blue" deleted
  route.route.openshift.io "quarkus-petclinic-bluegreen" deleted
----

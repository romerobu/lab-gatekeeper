image:logoopenshift.png[logoopenshift, width=150, height=150]
image:logokubernetes.png[logokubernetes, width=150, height=150]
image:logogatekeeper.svg[logogatekeeper, width=150, height=150]

= Introduction & Warm up
:author: Coral Romero
:email: cromerob@redhat.com
:imagesdir: ./images
:toc: left
:toc-title: Lab 0 - Warming up

[Abstract]

WARNING: This is not a recommended practices guide nor intended to serve as a reference. These series of labs are oriented in such a way that you will have a first contact to the main concepts of Open Policy Agent and Gatekeeper operator.

In this preparation lab, we are going to get the `oc` cli binary and validate that all necessary requirements are successfully accomplished before starting the series of labs. 

Along these labs, you will refer to a list of variables that have been shared with you before starting the labs. If this is not your case, please let us know. 

These variables are:

- *$OCP_CONSOLE*: url for accessing to the 
Openshift web console
- *$OCP_API*: Openshift API endpoint. We will use this endpoint when accesing the cluster from the `oc` cli.
- *$USER*: your private user id used for Openshift authentication
- *$PASSWORD*:  your secret password used for Openshift authentication
- *$LABS_HOME*: name of the laboratory

Feel free to export these variables in your environment if you don't have any connectivity issue.

:numbered:
== Access to Openshift Web Console

Use the `*$OCP_CONSOLE*` url to acces the Openshift Web Console. 

A login screen will be shown as follow after selecting `Local Password`:

image:login.png[login]

Enter your `username` and `password` and click `Log In`.

Then switch to `Administrator` perspective by clicking on the upper left banner:

image:administrator.png[administrator]

If you have successfully logged in, you will landed at the main dashboard with your current projects. As seen below, you should have access to 6 namespaces, `openshift-operators`, `petclinic-bluegreen-$USER`, `petclinic-beta-$USER`, `petclinic-test-$USER` and `openshift-gatekeeper-system`. Furthermore you will find an additional namespace for web terminal called `$USER-terminal`.

image:namespaces.png[namespaces]

Depending on where you are going to run this lab, you can do it from your CLI or from your own OCP Web terminal. Jump to the section that best suits your needs.

=== Download the CLI 

On the top-right (?) menu, click on `Command line tools`:

image:menu.png[menu]

Then, choose the binaries according to your OS:

image:binaries.png[binaries]


Extract the binaries and try it by executing the following:

....
$ oc get clusterversion

NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version   4.7.12    True        False         5d      Cluster version is 4.7.12
....

The above is an example of what you should get when running the command.

Finally verify you can log in from your terminal:

----
oc login -u $USER -p $PASSWORD $OCP_API
Login successful.

You have access to the following projects and can switch between them with ' project <projectname>':

  * openshift-gatekeeper-system
    openshift-operators
    petclinic-beta-$USER
    petclinic-test-$USER
    petclinic-bluegreen-$USER
    $USER-terminal
----

=== Web terminal

In order to avoid any kind of problem or connectivity issue between your laptop and the cluster, there is a `web-terminal` deployed for each of you. 

To access the `web-terminal` click on the `>_` icon which is located on the righ corner on the top:

image:menu.png[Web terminal]

Then, you will be asked to choose a project to initialize the terminal. Select the one that ends with `-terminal`:

image:init-terminal.png[Init terminal]

Finally, after some seconds, the terminal will show a prompt like this:

image:terminal-on.png[Terminal on]

Click on `Open terminal on a new tab` and start working on the new one (you can safely close the first one).

=== Init environment

To simplify the `environment variables` creation, each of you have a `user-config ConfigMap` with specific info about the environment. 

To load all the variables run:

....
$ export $(oc get cm user-config -o jsonpath='{.data.env}')
....

NOTE: In case you close the `web-terminal` by accident, you will have to re-run above command to set the environment variables again.

If you want to check the content of the `ConfigMap`, feel free to do so through the console or by running:

....
$ oc get cm user-config -o yaml
....


=== Clone lab

There is also a list of files needed to run the labs. These files can be found in the following github repository:

https://github.com/romerobu/lab-gatekeeper.git

Clone the repository to your desired location, that will then be referred as *$LABS_HOME* during the labs:

....
$ git clone https://github.com/romerobu/lab-gatekeeper.git

cd $LABS_HOME
....


=== Gatekeeper operator


Gatekeeper operator can be installed via Red Hat Marketplace or by creating a Subscription resource. For installing an operator you need to have `cluster-admin` role while your user has `gatekeeper-ops-role`.
This role limits the privileges of your user so you won't be able to run cluster wide actions but you will have enough privileges for create, get, list, delete, patch, update and watch gatekeeper resources among others.

Furthermore you will find a `Gatekeeper` resource created with the basic configuration needed for logs and audit feature.

Change your view mode to `Administrator` on the upper left banner and you can check the installed operator for this lab on `Operators` -> `Installed Operators`:

WARNING: Select namespace `openshift-operators`.

image:operator.png[operator]

Additionally you can check existing `Gatekeeper` resource with command:

WARNING: Your user only has permissions to get and list this resource.

----
oc get gatekeepers gatekeeper -o yaml
----

Otherwise you can navigate to `Gatekeeper` tab on the operator section:

image:gatekeeper.png[gatekeeper]


